import{r as v}from"./react-vendor-CM6QddGd.js";import{h as _,P as y,M as E}from"./index-8zYlZnql.js";function b(p,s="Ouonnki TV"){v.useEffect(()=>{const e=document.title;return p?document.title=`${p} - ${s}`:document.title=s,()=>{document.title=e}},[p,s])}class g{async fetchWithTimeout(s,e={},r=1e4,t=3){const n=new AbortController,c=setTimeout(()=>{n.abort("request timeout")},r);try{const o=await fetch(s,{...e,signal:n.signal});return clearTimeout(c),o}catch(o){if(clearTimeout(c),t>0)return console.warn(`请求失败，正在重试 (剩余${t}次):`,o),this.fetchWithTimeout(s,e,r,t-1);throw o}}buildApiUrl(s,e,r){const t=s.replace(/\/+$/,""),[n,c]=e.split("?");if(t.toLowerCase().endsWith(n.replace(/\/+$/,"").toLowerCase())||t.toLowerCase().includes("/api.php/provide/vod")){const o=t.includes("?")?"&":"?";return`${t}${o}${c}${r}`}return`${t}${e}${r}`}async searchVideos(s,e){try{if(!s)throw new Error("缺少搜索参数");if(!e||!e.url)throw new Error("无效的API配置");const r=this.buildApiUrl(e.url,_.search.path,encodeURIComponent(s)),t=await this.fetchWithTimeout(y+encodeURIComponent(r),{headers:_.search.headers},e.timeout,e.retry);if(!t.ok)throw new Error(`API请求失败: ${t.status}`);const n=await t.json();if(!n||!Array.isArray(n.list))throw new Error("API返回的数据格式无效");return n.list.forEach(c=>{c.source_name=e.name,c.source_code=e.id,c.api_url=e.url}),{code:200,list:n.list||[]}}catch(r){return console.error("搜索错误:",r),{code:400,msg:r instanceof Error?r.message:"请求处理失败",list:[]}}}async getVideoDetail(s,e){try{if(!s)throw new Error("缺少视频ID参数");if(!/^[\w-]+$/.test(s))throw new Error("无效的视频ID格式");if(!e||!e.url)throw new Error("无效的API配置");const r=e.detailUrl||e.url,t=this.buildApiUrl(r,_.detail.path,s),n=await this.fetchWithTimeout(y+encodeURIComponent(t),{headers:_.detail.headers});if(!n.ok)throw new Error(`详情请求失败: ${n.status}`);const c=await n.json();if(!c||!c.list||!Array.isArray(c.list)||c.list.length===0)throw new Error("获取到的详情内容无效");const o=c.list[0];let u=[],h=[];if(o.vod_play_url){const i=o.vod_play_url.split("$$$"),d=(o.vod_play_from||"").split("$$$");if(i.length>0){let a=d.findIndex(l=>l.toLowerCase().includes("m3u8"));a===-1&&(a=i.length-1),a>=i.length&&(a=i.length-1);const f=i[a].split("#");u=f.map(l=>{const w=l.split("$");return w.length>1?w[1]:""}).filter(l=>l&&(l.startsWith("http://")||l.startsWith("https://"))),h=f.map((l,w)=>{const $=l.split("$");return $.length>1?$[0]:`第${w+1}集`})}}return u.length===0&&o.vod_content&&(u=(o.vod_content.match(E)||[]).map(d=>d.replace(/^\$/,""))),{code:200,episodes:u,detailUrl:t,videoInfo:{title:o.vod_name,cover:o.vod_pic,desc:o.vod_content,type:o.type_name,year:o.vod_year,area:o.vod_area,director:o.vod_director,actor:o.vod_actor,remarks:o.vod_remarks,source_name:e.name,source_code:e.id,episodes_names:h}}}catch(r){return console.error("详情获取错误:",r),{code:400,msg:r instanceof Error?r.message:"请求处理失败",episodes:[]}}}createConcurrencyLimiter(s){let e=0;const r=[],t=()=>{for(;e<s&&r.length>0;){const n=r.shift();n&&(e++,n())}};return n=>new Promise((c,o)=>{const u=()=>{n().then(c).catch(o).finally(()=>{e--,t()})};r.push(u),t()})}aggregatedSearch(s,e,r,t){if(e.length===0)return console.warn("没有选中任何 API 源"),Promise.resolve([]);let n=!1;if(t){if(t.aborted)return Promise.reject(new DOMException("Aborted","AbortError"));t.addEventListener("abort",()=>{n=!0})}const c=new Set,o=this.createConcurrencyLimiter(3),u=e.map(i=>o(async()=>{if(n)return[];let d=[];try{d=await this.searchSingleSource(s,i)}catch(m){if(n)return[];console.warn(`${i.name} 源搜索失败:`,m)}if(n)return[];const a=d.filter(m=>{const f=`${m.source_code}_${m.vod_id}`;return c.has(f)?!1:(c.add(f),!0)});return n||a.length===0?[]:(r(a),a)})),h=Promise.all(u).then(i=>i.flat());if(t){const i=new Promise((d,a)=>{t.addEventListener("abort",()=>{a(new DOMException("Aborted","AbortError"))})});return Promise.race([h,i])}return h}async searchSingleSource(s,e){try{const r=await this.searchVideos(s,e);return r.code===200&&r.list?r.list:[]}catch(r){return console.warn(`${e.name}源搜索失败:`,r),[]}}}const I=new g;export{I as a,b as u};
